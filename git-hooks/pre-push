#!/bin/sh

# Get the list of pushed refs from stdin (standard for git pre-push hooks)
while read -r local_ref local_sha remote_ref remote_sha; do
    # If this is a new branch (remote_sha is all zeroes), diff against nothing
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        base="HEAD"
    else
        base="$remote_sha"
    fi

    break  # we only need the first line for most pushes
done

# Get changed files between base and HEAD
changed_files=$(git diff --name-only "$base"..HEAD)

# Extract version directories from changed files
versions=$(echo "$changed_files" | grep -oE '^v[0-9]+' | sort -u)

if [ -z "$versions" ]; then
    echo "No versioned directories changed. Skipping tests."
    exit 0
fi

status=0

for v in $versions; do
    echo "Running tests for changed version: $v"
    go test --tags testing "./$v/..." || status=$?
done

exit $status

